-- file: test.hs
--
module Main ( main) where

import Types ( M, V, XMeas (..), HMeas (..) , PMeas (..), Prong (..) )
import Coeff ( w2pt, h2p4, q2p4, invMass, showErr )
import Matrix ( inv, sw, fromList, fromList2 )
import Fit ( fit )

hSlurp :: [Double] -> (XMeas, [HMeas])
hSlurp inp = (v, hl) where
  v0        = fromList 3 $ take 3 inp
  cv0       = fromList2 3 3 $ take 9 $ drop 3 inp
  v         = XMeas v0 cv0
  w2pt      = inp !! 12
  nt        = round (inp !! 13) ::Int
  i0        = drop 14 inp
  lst       = (nt-1)*30
  is        = [ drop n i0 | n <-[0,30..lst]]
  hl        = [ nxtH i | i <- is ]

nxtH :: [Double] -> HMeas
nxtH i = HMeas h ch where
      (ih, ich) = splitAt 5 i
      h         = fromList 5 ih
      ch        = fromList2 5 5 $ take 25 ich

hFilter :: ( Eq a, Enum a, Num a ) => [b] -> [a] -> [b]
hFilter hl rng =
-- filter list of tracks of helices etc given list of indices in [a]
-- return list with only those b that have  indices that  are in rng [a]
  [h | (h, i) <- zip hl [0..], i `elem` rng ]
main :: IO ()
main = do
    let (v, hl)     = hSlurp inp
    let l5 = [0,2,3,4,5]
    let l5' = [0,1,2,4,5]
    let XMeas v0 cv0 = v
    let HMeas h0 ch0 = head hl
    print w2pt
    print v0
    print $ sw v0 cv0
    print h0
    print $ sw h0 ch0
--    print [h | (HMeas h _) <- hl]

    mapM_ (showErr "px,py,pz,E ->" . h2p4) hl

    let pl              = map h2p4 hl
    print $ invMass pl

    let pl5             = map h2p4 $ hFilter hl l5
    print $ invMass pl5

    putStrLn            "Fitting Vertex --------------------"
    let Prong n vf ql cl = fit v hl
--    print vf
    let pl               = map q2p4 ql
    print $ invMass pl
    let ql5              = map q2p4 $ hFilter ql l5
    print $ invMass ql5
    putStrLn            "Re-fitting Vertex-----------------"
    let Prong n vf ql cl = fit v $ hFilter hl l5
    let pl               = map q2p4 ql
    print $ invMass pl

inp = [
  3.355679512023926,      3.489715576171875,      7.110095977783203,
  0.2884106636047363,     0.2967556118965149,     0.4457152485847473,
  0.2967556118965149,     0.3057302236557007,     0.4589158892631531,
  0.4457152485847473,     0.4589158892631531,     0.7007381319999695,
  4.5451703E-03,
           6,
  9.0513890609145164E-04,  1.174186706542969,     0.7913663387298584,
 -5.4129425436258316E-02,  1.309153556823730,
  3.0409931517372257E-11, 3.0817798313265143E-10,-2.6150961396353978E-09,
 -6.2086684238238377E-08, 1.9006475560079394E-10, 3.0817798313265143E-10,
  3.5358195873413933E-06,-5.5664237663677341E-09,-4.7704439509743679E-08,
 -3.5389247932471335E-04,-2.6150961396353978E-09,-5.5664237663677341E-09,
  3.9334932466772443E-07, 9.2603177108685486E-06,-4.2692363422247581E-07,
 -6.2086684238238377E-08,-4.7704439509743679E-08, 9.2603177108685486E-06,
  2.7857377426698804E-04,-1.2511900422396138E-05, 1.9006475560079394E-10,
 -3.5389247932471335E-04,-4.2692363422247581E-07,-1.2511900422396138E-05,
  4.6403184533119202E-02,
 -3.2948562875390053E-04, -1.287435531616211,      3.964143753051758,
 -5.5920504033565521E-02,  2.172087669372559,
  1.0773015292342425E-11, 1.0870629917059116E-11,-9.4798713323740458E-10,
 -2.6224558524745589E-08, 5.1304871462320989E-10, 1.0870629917059116E-11,
  1.3991236755828140E-06, 6.1739335865951261E-11, 3.9363889925425610E-09,
 -1.3362320896703750E-04,-9.4798713323740458E-10, 6.1739335865951261E-11,
  1.0642112613368226E-07, 3.0040880574233597E-06,-5.7571856615368233E-08,
 -2.6224558524745589E-08, 3.9363889925425610E-09, 3.0040880574233597E-06,
  1.0815335554070771E-04,-1.6780244322944782E-06, 5.1304871462320989E-10,
 -1.3362320896703750E-04,-5.7571856615368233E-08,-1.6780244322944782E-06,
  1.5890464186668396E-02,
  8.6099491454660892E-04,  1.190025329589844,     0.7718949913978577,
  -1.004449844360352,      4.974927902221680,
  7.8076378695612902E-10,-2.4755367200590683E-10,-1.0359136126680824E-07,
 -6.7278465394338127E-06, 4.4596313841793744E-07,-2.4755367200590683E-10,
  6.6328821048955433E-06, 2.8732655366070503E-08, 1.5816522136447020E-06,
 -8.9828821364790201E-04,-1.0359136126680824E-07, 2.8732655366070503E-08,
  1.3829509043716826E-05, 9.0345303760841489E-04,-5.9563441027421504E-05,
 -6.7278465394338127E-06, 1.5816522136447020E-06, 9.0345303760841489E-04,
  5.9390719980001450E-02,-3.8860931526869535E-03, 4.4596313841793744E-07,
 -8.9828821364790201E-04,-5.9563441027421504E-05,-3.8860931526869535E-03,
  0.1251238286495209,
 -1.7263018526136875E-03,  1.039703369140625,     0.8659646511077881,
  0.2599024176597595,      2.128120422363281,
  1.5148657328545312E-10,-7.3402152411805588E-11,-1.4714315987873761E-08,
 -6.3192055677063763E-07,-3.4522088299127063E-08,-7.3402152411805588E-11,
  1.5436929743373184E-06,-5.5447091362736955E-10,-8.1613094948806975E-08,
 -1.5131152758840472E-04,-1.4714315987873761E-08,-5.5447091362736955E-10,
  1.5367089645224041E-06, 6.8635607021860778E-05, 4.2090109673154075E-06,
 -6.3192055677063763E-07,-8.1613094948806975E-08, 6.8635607021860778E-05,
  3.2065853010863066E-03, 1.9913408323191106E-04,-3.4522088299127063E-08,
 -1.5131152758840472E-04, 4.2090109673154075E-06, 1.9913408323191106E-04,
  1.7373077571392059E-02,
  1.2108741793781519E-03,  1.282915115356445,     0.8532057404518127,
  8.5045360028743744E-03,  1.965600013732910,
  3.6512477069594595E-11, 8.9357354848829118E-10,-3.3482463468459400E-09,
 -8.1875484170268464E-08, 9.6036401053822829E-10, 8.9357354848829118E-10,
  3.0787202831561444E-06,-2.2171841251861224E-08,-2.7003440550288360E-07,
 -1.5695679758209735E-04,-3.3482463468459400E-09,-2.2171841251861224E-08,
  5.5774097518224153E-07, 1.3075616152491421E-05,-4.9851792027766351E-07,
 -8.1875484170268464E-08,-2.7003440550288360E-07, 1.3075616152491421E-05,
  3.5224124439992011E-04,-1.4417236343433615E-05, 9.6036401053822829E-10,
 -1.5695679758209735E-04,-4.9851792027766351E-07,-1.4417236343433615E-05,
  1.7541546374559402E-02,
 -7.3608336970210075E-04,  1.297574043273926,     0.8316786885261536,
  -1.011060714721680,     -2.867138862609863,
  2.0176718074083055E-09, 9.1418789205377493E-10,-2.5551665316925209E-07,
 -1.5318933947128244E-05,-3.4175937457803229E-07, 9.1418789205377493E-10,
  7.4829795266850851E-06,-1.1038221003900617E-07,-6.1672653828281909E-06,
 -9.3757675494998693E-04,-2.5551665316925209E-07,-1.1038221003900617E-07,
  3.2483072573086247E-05, 1.9545238465070724E-03, 4.3123862269567326E-05,
 -1.5318933947128244E-05,-6.1672653828281909E-06, 1.9545238465070724E-03,
  0.1181144416332245,     2.5763250887393951E-03,-3.4175937457803229E-07,
 -9.3757675494998693E-04, 4.3123862269567326E-05, 2.5763250887393951E-03,
  0.1227073818445206
      ]

inp' = [
   2.136457443237305,    -0.1078032255172729,     0.1303804516792297,
  0.7886843681335449,    -5.5918879806995392E-02, 5.0620362162590027E-03,
 -5.5918879806995392E-02, 4.1231140494346619E-03,-3.5905139520764351E-04,
  5.0620362162590027E-03,-3.5905139520764351E-04, 6.7064235918223858E-04,
  4.5451703E-03,
           6,
 -3.0485540628433228E-04, 2.8883922845125198E-02,  6.199183464050293,
 -6.7928363569080830E-04, 0.2044387459754944,
  2.6806892816644279E-10, 3.9138565435456463E-13,-3.3533058996226828E-08,
 -1.9916849396395264E-06,-7.0507494287497252E-10, 3.9138565435456463E-13,
  3.5714398904929112E-07,-4.9284173964103672E-11, 0.0000000000000000E+00,
 -4.4667751353699714E-05,-3.3533058996226828E-08,-4.9284173964103672E-11,
  4.2506135287112556E-06, 2.5612217723391950E-04, 8.2442880966482335E-08,
 -1.9916849396395264E-06, 0.0000000000000000E+00, 2.5612217723391950E-04,
  1.5718121081590652E-02, 5.0133462536905427E-06,-7.0507494287497252E-10,
 -4.4667751353699714E-05, 8.2442880966482335E-08, 5.0133462536905427E-06,
  5.9135467745363712E-03,
  5.7805865071713924E-04,-2.7371905744075775E-02,  6.212650299072266 ,
 -5.0330821424722672E-02, 0.2669380903244019,
  2.2938300564545600E-11,-1.2320395354967206E-12,-1.8564442205715181E-09,
 -4.3664631022011235E-08,-3.6330632946501851E-11,-1.2320395354967206E-12,
  2.8721402145492902E-07,-1.1364534313607066E-11,-5.8715182715829428E-10,
 -2.0256495190551504E-05,-1.8564442205715181E-09,-1.1364534313607066E-11,
  2.8104619786972762E-07, 6.4627079154888634E-06, 5.0267954243565782E-09,
 -4.3664631022011235E-08,-5.8715182715829428E-10, 6.4627079154888634E-06,
  1.8754918710328639E-04, 1.2985537978238426E-07,-3.6330632946501851E-11,
 -2.0256495190551504E-05, 5.0267954243565782E-09, 1.2985537978238426E-07,
  2.2477332968264818E-03,
  1.0503018274903297E-03, 4.3847940862178802E-02,  6.159751892089844,
  8.0430150032043457E-02, 9.2897377908229828E-03,
  5.1628668007452916E-10,-1.0509984375850490E-11,-6.1622543512385164E-08,
 -3.4704646623140434E-06, 6.6013137178799752E-09,-1.0509984375850490E-11,
  4.1271306372436811E-07, 9.8449870478134471E-10, 3.6602052944090246E-08,
 -5.0192138587590307E-05,-6.1622543512385164E-08, 9.8449870478134471E-10,
  7.4886920629069209E-06, 4.2879732791334391E-04,-8.0387178513774415E-07,
 -3.4704646623140434E-06, 3.6602052944090246E-08, 4.2879732791334391E-04,
  2.5047110393643379E-02,-4.5468565076589584E-05, 6.6013137178799752E-09,
 -5.0192138587590307E-05,-8.0387178513774415E-07,-4.5468565076589584E-05,
  6.5127559937536716E-03,
 -5.9809628874063492E-04,-2.2054553031921387E-02,  3.036677360534668,
  7.5348675251007080E-02, 0.2973222732543945,
  2.3578056174144990E-11, 1.1115124662688936E-12,-1.7554296904975786E-09,
 -4.2304989733565890E-08, 8.3801394643034932E-12, 1.1115124662688936E-12,
  2.7065456720265502E-07,-1.0590551872968756E-11, 0.0000000000000000E+00,
 -1.7868160284706391E-05,-1.7554296904975786E-09,-1.0590551872968756E-11,
  2.5900129685396678E-07, 6.2359408730117138E-06,-3.5132432518736323E-09,
 -4.2304989733565890E-08, 0.0000000000000000E+00, 6.2359408730117138E-06,
  1.8259086937177926E-04,-1.1660220877729444E-07, 8.3801394643034932E-12,
 -1.7868160284706391E-05,-3.5132432518736323E-09,-1.1660220877729444E-07,
  1.8615493318066001E-03,
 -1.8792329356074333E-03, 1.0289877653121948E-02,  6.178173065185547,
 -2.3212472442537546E-03, 6.9315016269683838E-02,
  3.3766822671310592E-10, 2.8056632538075998E-12,-3.2504981817282896E-08,
 -1.3839548955729697E-06,-1.0514722426080425E-09, 2.8056632538075998E-12,
  2.9734786721746786E-07,-3.1836874803126136E-10,-1.0812726713993470E-08,
 -2.5584682589396834E-05,-3.2504981817282896E-08,-3.1836874803126136E-10,
  3.3288649774476653E-06, 1.4725867367815226E-04, 1.0440007258694095E-07,
 -1.3839548955729697E-06,-1.0812726713993470E-08, 1.4725867367815226E-04,
  6.8262652494013309E-03, 4.5587944441649597E-06,-1.0514722426080425E-09,
 -2.5584682589396834E-05, 1.0440007258694095E-07, 4.5587944441649597E-06,
  2.6101735420525074E-03,
  7.8127859160304070E-04, 1.7319824546575546E-02,  6.212795257568359,
  2.5973606854677200E-02,-1.0897099971771240E-02,
  1.4856260666107346E-10,-1.0977668427059051E-12,-1.5961289179244886E-08,
 -7.6876762022948242E-07, 4.0069358941963173E-10,-1.0977668427059051E-12,
  2.0279195211969636E-07, 9.5926815102398422E-11, 2.4196529224695951E-09,
 -2.1838872271473520E-05,-1.5961289179244886E-08, 9.5926815102398422E-11,
  1.7725128600432072E-06, 8.7759915913920850E-05,-4.6503028983124750E-08,
 -7.6876762022948242E-07, 2.4196529224695951E-09, 8.7759915913920850E-05,
  4.5110275968909264E-03,-2.2079811969888397E-06, 4.0069358941963173E-10,
 -2.1838872271473520E-05,-4.6503028983124750E-08,-2.2079811969888397E-06,
  2.6384890079498291E-03
       ]
